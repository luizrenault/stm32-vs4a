<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.4"/>
<title>STVS4A: Introduction</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="ST_logo-small.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">STVS4A
   &#160;<span id="projectnumber">v1.1.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.4 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('introduction.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Introduction </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><html>

<head>
<meta http-equiv=Content-Type content="text/html; charset=utf-8">
<meta name=Generator content="Microsoft Word 15 (filtered)">
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:"Calibri Light";
	panose-1:2 15 3 2 2 2 4 3 2 4;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:62.95pt;
	margin-bottom:.0001pt;
	line-height:120%;
	font-size:10.0pt;
	font-family:"Arial",sans-serif;}
h1
	{mso-style-link:"Heading 1 Char";
	margin-top:12.0pt;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:62.95pt;
	margin-bottom:.0001pt;
	line-height:120%;
	page-break-after:avoid;
	font-size:16.0pt;
	font-family:"Calibri Light",sans-serif;
	color:#2E74B5;
	font-weight:normal;}
span.Heading1Char
	{mso-style-name:"Heading 1 Char";
	mso-style-link:"Heading 1";
	font-family:"Calibri Light",sans-serif;
	color:#2E74B5;}
.MsoChpDefault
	{font-family:"Calibri",sans-serif;}
.MsoPapDefault
	{margin-bottom:8.0pt;
	line-height:107%;}
@page WordSection1
	{size:8.5in 11.0in;
	margin:1.0in 1.0in 1.0in 1.0in;}
div.WordSection1
	{page:WordSection1;}
-->
</style>

</head>

<body lang=EN-US>

<div class=WordSection1>

<h1>STVS4A package </h1>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal style='text-align:justify'><i>This reference manual
describes in detail the content of the STM32Cube software expansion package to
enable Amazon® AVS® interfacing from a STM32application.</i></p>

<p class=MsoNormal style='text-align:justify'>The reference manual describes
the API and the interaction between the Application and the server.</p>

<p class=MsoNormal>&nbsp;</p>

<h1>Architecture and dependencies </h1>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal style='text-align:justify'>STVS4A is a Middleware working
with several dependences.  Some dependences are part of the package the
standard STM32 delivery, some other come from the open source community. There
are two packages released as binaries. <b>SpiritDSP MP3 </b>doesn’t use
dependences and can be used freely in the application, but the stack HTTP/2 is
linked with FreeRTOS, LWIP, and mbedTLS API. This means that the change of their
configuration header must be done carefully. All configurations change that
modify a struct exposed in the configuration header could cause failures in the
STVS4A application. In this case, the HTTP/2 library must be re-built using the
new configuration.</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal align=center style='text-align:center'><img width=624
height=360 id="Picture 1" src="Introduction_image001.jpg"></p>

<p class=MsoNormal align=center style='text-align:center'>STVS4A Depandances</p>

<h1>STVS4A Internal</h1>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>The aims of the section are not to describe the internal of STVS4A,
but just give an overview of the architecture and how modules communicate
between them.</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal style='text-align:justify'>STVS4A use 3 main layers, the
first one is the SDK entry, all functions coming from the application goes to <b>avs_sdk_entry_imp.
</b>This module is in charge to check parameters, eventually lock the function,
and execute it. </p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal style='text-align:justify'>STVS4A core manages the AVS
protocol with the server, the protocol includes audio management, network
directive/event parsing. This layer has no platform dependencies. The support of
network, board, and some other element that are delegated in the porting layer.
The STVS4A core communicates with HW dependences using drivers and IOCTL
implemented in the porting layer. As introduced before, the porting layer connects
the Core with the Hardware or configuration variance. The <b>avs_porting_imp</b>
does this link.</p>

<p class=MsoNormal> </p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal align=center style='text-align:center'><img width=624
height=436 id="Picture 2" src="Introduction_image002.jpg"></p>

<p class=MsoNormal align=center style='text-align:center'>STVS4A Internal</p>

<p class=MsoNormal align=center style='text-align:center'>&nbsp;</p>

<p class=MsoNormal align=center style='text-align:center'>&nbsp;</p>

<h1>Avs_audio_imp</h1>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal style='text-align:justify'>This module is in charge to
manage all audio aspects. Alexa speaks using an MP3 file at 24K two channels and
expects an audio input samples at 16K one channel and 16 bits.  Avs_audio
creates 2 threads in charge to pump samples from the ring buffer and to copy it
in a second buffer and eventually applies a sample rate conversion if those two
buffers have different rates and channels. The sample processing is not
equivalent for the microphone and the speaker. Pipes are mapped as follow.</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal align=center style='text-align:center'><img width=565
height=186 id="Picture 4" src="Introduction_image003.jpg"></p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal align=center style='text-align:center'>Audio pipes block
diagram </p>

<p class=MsoNormal align=center style='text-align:center'>&nbsp;</p>

<p class=MsoNormal style='text-align:justify'>&nbsp;</p>

<p class=MsoNormal style='text-align:justify'>Notice that the recognizer pipe
has a Sample Rate Converter, but the processing is disabled, it is not the case
for other pipes. The SRC is active only when it is mandatory.  Network
pipelines are managed by STVS4A, but the Sound and the Auxiliary stream are in
the control of the application. Auxiliary pipe is mainly used for the media player. 
The HW stream input and output have a fixed frequency, it I possible to change it
in the instance factory. </p>

<h1>Avs_state_imp</h1>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal style='text-align:justify'>The state module creates one
thread and manages the AVS interaction cycle. An interaction cycle starts with
a <b>StartCapture</b> state and finishes with an <b>IDLE</b> state. According
to the interaction model, this module can use a simple-turn model or
multi-turn. In this case, Alexa will generate several sequences of <b>StartCapture</b>
before to finish it cycle. Notice that this module is also in charge to manage
the network perturbation or disconnection. If an issue is reported by another
module, the state thread will try to kindly disconnect the network and try to
reconnect it, until the connection is ready.  The state thread is also in
charge to pull/push network payloads and feed audio buffer during the AVS
interaction Capture and Speak.</p>

<h1>Avs_network_imp</h1>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal style='text-align:justify'>This module doesn’t create thread
directly, but Network API dependences do it. This module creates a network abstraction
and exposes basic network services for other modules. <b>Avs_Network</b> setup
the network and manage IP Gateway DNS, TLS, network time, etc. This module
doesn’t implement directly those services, the real implementation is done in
the Porting Layer. Today the porting layer supports LWIP or Cyclone stacks.</p>

<h1>Avs_token_imp</h1>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal style='text-align:justify'>This module creates one thread
and manage the HTTP2 token using a TLS connection. This token takes the form of
a character string. The first token is retrieved using the AVS grant code
authentication mechanism. A HTTP/2 connection with the server supposes to
transmit a token for each transaction. This token has a limited persistence,
the server will keep the connection with the same token during 60 minutes. When
the time is over, all transactions will be rejected.  This module manages the
token renew. The token renew occurs automatically every 50 minutes. In some
rare occasion, we may need to force the token renew, STVS4A exposes the  IOCTL AVS_NETWORK_RENEW_TOKEN
to force the token renew (for example, we use the mechanism in the endurance
test sample code).</p>

<h1>Avs_http2_imp</h1>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal style='text-align:justify'>This module creates one thread
and manage the HTTP/2 connection. This thread restart for each HTTP/2 session
and manage 4 streams (the number of streams could be modified by configuration).
When a network error occurs, the thread is restarted from scratch. The module
starts by some authentication transaction with the server, then it manages the downstream
channel LiveCycle and exposes also a set of API to manage http/2 streams for
other modules.</p>

<h1>avs_directive_imp</h1>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal style='text-align:justify'>This module creates one thread.
The thread manages the downstream channels. Downstream channels allow to
receive directives from the server and may occurs at any time. Notice that the
server could also send directives via the <b>state thread </b>and the event
recognizer when it transits from the state capture to speak. During the server
response, and in the multi-part section, the JSON could embed some directives.
The directive module is also in charge to parse incoming directive and dispatch
the result of its parse via the STVS4A event mechanism. This module also
exposes some API to manage directive to other modules.</p>

<h1>Avs_json_formater_imp</h1>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal style='text-align:justify'>This module doesn’t create
threads. The transaction with AVS server is done using events and directives. Both
uses JSON strings as a communication supports. This module exposes some API to format
those Event and Directive for other modules. It is also in charge to manage the
specific memory pool of short persistence object in order to limit and contain
the memory fragmentation in the heap. </p>

<h1>Avs_core_imp</h1>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal style='text-align:justify'>This module doesn’t create
threads, this module exposes a set of general API used by other modules. It provides
an OS abstraction, expose pooled memory API, and debug tools and many other
utilities useful for STVS4A.</p>

<h1>Avs_mem_imp</h1>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal style='text-align:justify'>This module doesn’t create
threads, this module manages a memory pool from a base address and a size. It
exposes an API used by other modules. The base address could be placed anywhere
and create a pool. This module is used to create DTCM, PRAM, SHORT_OBJECT pools.
The pool API replicate exactly of the stdlib (parameters and behaviors, malloc,
calloc, realloc, free), except that the first parameters is a memory pool
pointer. The memory pool manager is highly instrumented to detect memory leak
and corruption. Using some specific configuration, this module could overload
the standard heap manager in order to track corruptions and leaks.</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>&nbsp;</p>

<h1>&nbsp;</h1>

</div>

</body>

</html>
 </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.4 </li>
  </ul>
</div>
</body>
</html>
