<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.4"/>
<title>STVS4A: Debugging</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="ST_logo-small.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">STVS4A
   &#160;<span id="projectnumber">v1.1.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.4 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('debugging.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Debugging </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><html>

<head>
<meta http-equiv=Content-Type content="text/html; charset=utf-8">
<meta name=Generator content="Microsoft Word 15 (filtered)">
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:Wingdings;
	panose-1:5 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:"Calibri Light";
	panose-1:2 15 3 2 2 2 4 3 2 4;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:62.95pt;
	margin-bottom:.0001pt;
	line-height:120%;
	font-size:10.0pt;
	font-family:"Arial",sans-serif;}
h1
	{mso-style-link:"Heading 1 Char";
	margin-top:12.0pt;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:62.95pt;
	margin-bottom:.0001pt;
	line-height:120%;
	page-break-after:avoid;
	font-size:16.0pt;
	font-family:"Calibri Light",sans-serif;
	color:#2E74B5;
	font-weight:normal;}
h2
	{mso-style-link:"Heading 2 Char";
	margin-top:2.0pt;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:62.95pt;
	margin-bottom:.0001pt;
	line-height:120%;
	page-break-after:avoid;
	font-size:13.0pt;
	font-family:"Calibri Light",sans-serif;
	color:#2E74B5;
	font-weight:normal;}
p.MsoHeader, li.MsoHeader, div.MsoHeader
	{mso-style-link:"Header Char";
	margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:62.95pt;
	margin-bottom:.0001pt;
	font-size:10.0pt;
	font-family:"Arial",sans-serif;}
p.MsoFooter, li.MsoFooter, div.MsoFooter
	{mso-style-link:"Footer Char";
	margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:62.95pt;
	margin-bottom:.0001pt;
	font-size:10.0pt;
	font-family:"Arial",sans-serif;}
a:link, span.MsoHyperlink
	{color:#0563C1;
	text-decoration:underline;}
a:visited, span.MsoHyperlinkFollowed
	{color:#954F72;
	text-decoration:underline;}
p.MsoNoSpacing, li.MsoNoSpacing, div.MsoNoSpacing
	{margin:0in;
	margin-bottom:.0001pt;
	text-align:justify;
	font-size:14.0pt;
	font-family:"Calibri",sans-serif;}
p.MsoListParagraph, li.MsoListParagraph, div.MsoListParagraph
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.5in;
	margin-bottom:.0001pt;
	line-height:120%;
	font-size:10.0pt;
	font-family:"Arial",sans-serif;}
p.MsoListParagraphCxSpFirst, li.MsoListParagraphCxSpFirst, div.MsoListParagraphCxSpFirst
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.5in;
	margin-bottom:.0001pt;
	line-height:120%;
	font-size:10.0pt;
	font-family:"Arial",sans-serif;}
p.MsoListParagraphCxSpMiddle, li.MsoListParagraphCxSpMiddle, div.MsoListParagraphCxSpMiddle
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.5in;
	margin-bottom:.0001pt;
	line-height:120%;
	font-size:10.0pt;
	font-family:"Arial",sans-serif;}
p.MsoListParagraphCxSpLast, li.MsoListParagraphCxSpLast, div.MsoListParagraphCxSpLast
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.5in;
	margin-bottom:.0001pt;
	line-height:120%;
	font-size:10.0pt;
	font-family:"Arial",sans-serif;}
span.Heading1Char
	{mso-style-name:"Heading 1 Char";
	mso-style-link:"Heading 1";
	font-family:"Calibri Light",sans-serif;
	color:#2E74B5;}
span.Heading2Char
	{mso-style-name:"Heading 2 Char";
	mso-style-link:"Heading 2";
	font-family:"Calibri Light",sans-serif;
	color:#2E74B5;}
span.HeaderChar
	{mso-style-name:"Header Char";
	mso-style-link:Header;
	font-family:"Arial",sans-serif;}
span.FooterChar
	{mso-style-name:"Footer Char";
	mso-style-link:Footer;
	font-family:"Arial",sans-serif;}
.MsoChpDefault
	{font-family:"Calibri",sans-serif;}
.MsoPapDefault
	{margin-bottom:8.0pt;
	line-height:107%;}
 /* Page Definitions */
 @page WordSection1
	{size:8.5in 11.0in;
	margin:1.0in 1.0in 1.0in 1.0in;}
div.WordSection1
	{page:WordSection1;}
 /* List Definitions */
 ol
	{margin-bottom:0in;}
ul
	{margin-bottom:0in;}
-->
</style>

</head>

<body lang=EN-US link="#0563C1" vlink="#954F72">

<div class=WordSection1>

<p class=MsoNormal style='margin-left:0in'>&nbsp;</p>

<h1 style='margin-left:0in'>General </h1>

<p class=MsoNormal style='margin-left:0in;text-align:justify'>&nbsp;</p>

<p class=MsoNormal style='margin-left:0in;text-align:justify'>STVS4A provides
some tools to help the application debugging. Memory leak tracking is critical
for MCU because the memory is a rare resource and a leak, even small, will
consume the memory and will crash for sure your application in a short or very
long delay. The JSON formatting is also a key point, the interaction and
dialogue model must be accurate with ALEXA expectations, and otherwise Alexa
will close the conversation.  The thread management is the last point we must
pay attention. An application must pay attention to the priorities and leave
enough CPU to the vital threads such as IP/HTTP/TLS. Usually an application
such as UI doesn’t need to run at the high level. For all those tricky aspects,
STVS4A provides tools to monitor and to be aware concerning the internal
machine states.</p>

<h1 style='margin-left:0in'><a name="_Toc505934208"></a><a name="_Toc498250073">Memory
Manager &amp; Integrity</a> </h1>

<p class=MsoNormal style='margin-left:0in'>&nbsp;</p>

<p class=MsoNormal style='margin-left:0in;text-align:justify'>STVS4A has an
instrumentation to track memory integrity. STVS4A uses memory pools completely
under the application control. Because the connection task could be deleted at
any time due to a disconnection. Allocated blocks must be controlled and
reinitialized for each startup. A memory pool manages small memory block for
temporary buffer. This block is created and deleted for each
Connection/disconnection HTTP/2. It possible to remove this management by
defining AVS_NO_SHORT_OBJECT_POOL in your project. In this case, short malloc
will uses the memory HEAP.</p>

<p class=MsoNormal style='margin-left:0in'>&nbsp;</p>

<h1 style='margin-left:0in'>Tracking corruptions</h1>

<p class=MsoNormal style='margin-left:0in'>&nbsp;</p>

<p class=MsoNormal style='margin-left:0in;text-align:justify'>&nbsp;</p>

<p class=MsoNormal style='margin-left:0in;text-align:justify'>Tracking memory
corruptions is always painful, STVS4A provides an instrumentation allowing to
check the heap integrity.  This mechanism is always active in debug mode for memory
pools. For each call to <b>malloc/free</b> functions, the module checks if the
database local pointer is coherent. It is also possible to active a more
intrusive tool that will perform a complete block chaining check. By default,
this task won’t be done since the flag m_checkFreq = 0. If the flag is greater
than 0, it represents the check frequency block chaining check. If m_checkFreq
= 1, the check will occur for each call to the alloc API, m_checkFreq = N, the
check will occur every N calls to the alloc API. Warning this tool is very
intrusive and will generate huge delay. If a corruption is detected, the memory
pool manager will generate an AVS_ASSERT.</p>

<p class=MsoNormal style='margin-left:0in;text-align:justify'>&nbsp;</p>

<p class=MsoNormal style='margin-left:0in;text-align:justify'>This mechanism
works for pools, but not for the HEAP because the HEAP is managed by stdlib. 
But it is possible to extend this mechanism to the HEAP on IAR tool chain. The
tools must be used carefully.  The define <b>AVS_USE_GLOBAL_CURRUPTION_TRACKER</b>
allows to substitute the stdlib HEAP to an AVS Pool. This flag must be used in
combination with a specific option in your project. Add the following lines in
the IAR linker Extra Option.</p>

<p class=MsoNormal style='margin-left:0in'>&nbsp;</p>

<p class=MsoNormal style='margin-left:0in'>&nbsp;</p>

<div align=center>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='background:#D9D9D9;border-collapse:collapse;border:none'>
 <tr>
  <td width=539 valign=top style='width:404.55pt;border:solid windowtext 1.0pt;
  padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-left:0in'>&nbsp;</p>
  <p class=MsoNormal style='margin-left:0in'>--redirect malloc=SAFE_malloc</p>
  <p class=MsoNormal style='margin-left:0in'>--redirect free=SAFE_free</p>
  <p class=MsoNormal style='margin-left:0in'>--redirect realloc=SAFE_realloc</p>
  <p class=MsoNormal style='margin-left:0in'>--redirect calloc=SAFE_calloc</p>
  <p class=MsoNormal style='margin-left:0in'>&nbsp;</p>
  </td>
 </tr>
</table>

</div>

<p class=MsoNormal align=center style='margin-left:0in;text-align:center'>Option
IAR linker Extra Option</p>

<p class=MsoNormal style='margin-left:0in'>&nbsp;</p>

<p class=MsoNormal style='margin-left:0in'>Using this build option, all calls
to stdlib API will be routed to an internal AVS equivalent, and STVS4A mem will
check the HEAP coherency.</p>

<p class=MsoNormal style='margin-left:0in'>&nbsp;</p>

<h1 style='margin-left:0in'>Tracking memory leaks</h1>

<p class=MsoNormal style='margin-left:0in'>&nbsp;</p>

<p class=MsoNormal style='margin-left:0in;text-align:justify'>When <b>AVS_USE_GLOBAL_CURRUPTION_TRACKER</b>
and <b>AVS_USE_LEAK_DETECTOR</b> are active, we can track memory leaks. This
tool is already mapped on the GUI example. When you clique on the ST logo, STVS4A
will print a memory mapping difference between the current memory chaining and
the last one. The tool will print also le fragment number in the HEAP. The
first click will display all fragments, the next one only the difference. To
use this tool correctly, you have to click once on the ST logo, then, do an
action on your application that you suspect to produce memory leaks, and then,
click again. If the number of fragment is unchanged, this means that there are
no leaks. If the number of fragment is different, this means that some
allocations are not freed and the console will print the address and size of
those fragments (you have to analyze those blocks and check if it is normal or
not). If the number of fragment is equal, but the tool prints some fragments, it
could be normal, it is probably due to some reallocations.</p>

<p class=MsoNormal style='margin-left:0in;text-align:justify'>&nbsp;</p>

<p class=MsoNormal style='margin-left:0in;text-align:justify'>In the following
console snippet. We can see 2 leaks.  The first one occurs before the event
“what time is it” and a second click after the interaction is completed. The
dump shows no leak (177 frags and total allocation of changed) and 1 re-alloc
due to the token exchanged between the server and STVS4A.</p>

<p class=MsoNormal style='margin-left:0in'>&nbsp;</p>

<p class=MsoNormal style='margin-left:0in'>&nbsp;</p>

<div align=center>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='background:#D9D9D9;border-collapse:collapse;border:none'>
 <tr>
  <td width=539 valign=top style='width:404.55pt;border:solid windowtext 1.0pt;
  padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-left:0in'>Leak detector :  Current 177
  frags, last 177 frags total : 214681 bytes</p>
  <p class=MsoNormal style='margin-left:0in'>  11:17:53 :  Start
  Rec                      : EVT_START_REC(0)</p>
  <p class=MsoNormal style='margin-left:0in'>  11:17:58 :  Stop
  Rec                       : EVT_STOP_REC(0)</p>
  <p class=MsoNormal style='margin-left:0in'>  11:17:58 :  Start
  Speak                    : EVT_START_SPEAK(0)</p>
  <p class=MsoNormal style='margin-left:0in'>  11:18:00 :  Stop
  Speak                     : EVT_STOP_SPEAK(0)</p>
  <p class=MsoNormal style='margin-left:0in'>Leak detector :  Current 177
  frags, last 177 frags total : 214562 bytes</p>
  <p class=MsoNormal style='margin-left:0in'><b><span lang=FR>000:New Block
  c0433810:00112</span></b></p>
  </td>
 </tr>
</table>

</div>

<p class=MsoNormal style='margin-left:0in'>&nbsp;</p>

<h1 style='margin-left:0in'><a name="_Toc505934206"></a><a name="_Toc498250063">Debugging
JSON</a></h1>

<p class=MsoNormal style='margin-left:0in'>&nbsp;</p>

<p class=MsoNormal style='margin-left:0in'>STVS4A provides a mechanism that dumps
JSON events and directives. STVS4A can dump JSON script on the serial console.
By default, this option is disabled, but you can enable it using the following
code.</p>

<p class=MsoNormal style='margin-left:0in'>&nbsp;</p>

<p class=MsoNormal style='margin-left:0in'>&nbsp;</p>

<div align=center>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='background:#D9D9D9;border-collapse:collapse;border:none'>
 <tr>
  <td width=539 valign=top style='width:404.55pt;border:solid windowtext 1.0pt;
  padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-left:0in'>AVS_Set_Debug_Level( </p>
  <p class=MsoNormal style='margin-left:0in'>AVS_TRACE_LVL_DEFAULT   | </p>
  <p class=MsoNormal style='margin-left:0in'><span lang=FR>_TRACE_LVL_JSON   | </span></p>
  <p class=MsoNormal style='margin-left:0in'><span lang=FR>AVS_TRACE_LVL_JSON_FORMATED
  );</span></p>
  <p class=MsoNormal style='margin-left:0in'><span lang=FR>&nbsp;</span></p>
  </td>
 </tr>
</table>

</div>

<p class=MsoNormal style='margin-left:0in'>&nbsp;</p>

<p class=MsoNormal style='margin-left:0in'>&nbsp;</p>

<p class=MsoNormal style='margin-left:0in'>&nbsp;</p>

<p class=MsoNormal style='margin-left:0in;text-align:justify'>There are two
options to visualize JSON scripts. JSON scripts are always sent or received in
compact mode by ALEXA.  AVS_TRACE_LVL_JSON allows to show JSON script exactly
as it was sent or received. If we add AVS_TRACE_LVL_JSON_FORMATED, STVS4A will
re-format the JSON script to be human readable. Notice: Using
AVS_TRACE_LVL_JSON_FORMATED takes time to print and format and could be
intrusive, if there are a too much traces in same time.</p>

<p class=MsoNormal style='margin-left:0in'>&nbsp;</p>

<h1 style='margin-left:0in'><a name="_Toc505934207"></a><a name="_Toc498250064">Build
Debug and instrumentation</a> </h1>

<p class=MsoNormal style='margin-left:0in'>&nbsp;</p>

<p class=MsoNormal style='margin-left:0in'>STVS4A is instrumented to provide a
maximum feedback to the developer during the application LiveCycle. STVS4A
shows traces from the core implementation and also in some demo services
provided in the package. STVS4A uses intensively asserts, AVS_ASSERT and
AVS_VERIFY are used to catch potential issues and reports them to the developer
where the error occurs. ASSERTS shows the file, line number and the reason of
the failure. </p>

<p class=MsoNormal style='margin-left:0in'>&nbsp;</p>

<p class=MsoNormal style='margin-left:0in'>AVS_ASSERT checks a result and fire
an exception if the condition is FALSE, AVS_VERIFY does the same, but the code
in the brackets will be kept in release build. At the opposite for AVS_ASSERT,
all code between brackets will be vanish in release build. It is very important
do not confuse both macros. ASSERS will produce the following traces on the
console and will never return (infinite loop you can break from the debugger
and inspect the call stack).</p>

<p class=MsoNormal style='margin-left:0in'>&nbsp;</p>

<div align=center>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='background:#D9D9D9;border-collapse:collapse;border:none'>
 <tr>
  <td width=623 valign=top style='width:467.5pt;border:solid windowtext 1.0pt;
  padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-left:0in'><span lang=FR>AVS_ASSERT(pHandle
  != 0);</span></p>
  <p class=MsoNormal><span lang=FR>&nbsp;</span></p>
  <p class=MsoNormal style='margin-left:0in'><span lang=FR>Console : Assert :
  pHandle != 0 mycode.c:147</span></p>
  <p class=MsoNormal style='margin-left:0in'><span lang=FR>&nbsp;</span></p>
  </td>
 </tr>
</table>

</div>

<p class=MsoNormal style='margin-left:0in'>&nbsp;</p>

<p class=MsoNormal style='margin-left:0in;text-align:justify'>AVS_VERIFY and
AVS_ASSERT produce a lot of character strings. So, this consumes the flash and
increase the flashing delay.  ASSERTS are available only in debug mode. In
release, macros do nothing. It is possible disable ASSERTS in debug mode using
AVS_NO_ASSERT if you want to save space in flash. The define AVS_USE_DEBUG
enables the code instrumentation. </p>

<p class=MsoNormal style='margin-left:0in;text-align:justify'>&nbsp;</p>

<p class=MsoNormal style='margin-left:0in;text-align:justify'>STVS4A exposes
some macros to print messages on the serial and filter them according to a
debug space.  There are several macros such as AVS_TRACE_XXX, the application
can select the debug space using <b>AVS_Set_Debug_Leve</b>l and
AVS_TRACE_LVL_XXXX debug space selector.  Those traces produce also a lot of
character strings. When the application is built in release mode, STVS4A
removes automatically some trace spaces and keeps only AVS_TRACE_LVL_ERROR and
AVS_TRACE_LVL_INFO. All other strings used with other trace levels will be
vanish.  The DEMO package has several build configurations. The “DELIVERY”
configuration, produces a code without instrumentation and built for the size
optimization. </p>

<p class=MsoNormal style='margin-left:0in'>&nbsp;</p>

<h1 style='margin-left:0in'>FreeRTOS Analyzer </h1>

<p class=MsoNormal style='margin-left:0in'>&nbsp;</p>

<p class=MsoNormal style='margin-left:0in'>STVS4A has a configuration ready to
use the tracealyzer from Percepio. This configuration is active only in IAR
tool chain.  Tracealyzer allows to monitor FreeRTOS objects and is a very powerful
tool to verify the perfect behavior of the operating system. To use tracealyzer,
select the configuration STAVE_XX_TRACEALYZER for the IAR configuration menu
and build the project. </p>

<p class=MsoNormal style='margin-left:0in'>&nbsp;</p>

<p class=MsoNormal style='margin-left:0in'>&nbsp;</p>

<p class=MsoNormal style='margin-left:0in'>Please visit the following links  </p>

<p class=MsoListParagraphCxSpFirst style='text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><a href="http://percepio.com/">http://percepio.com/</a></p>

<p class=MsoListParagraphCxSpMiddle style='text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span><a href="https://percepio.com/iar/">https://percepio.com/iar/</a></p>

<p class=MsoListParagraphCxSpMiddle>&nbsp;</p>

<p class=MsoListParagraphCxSpMiddle>&nbsp;</p>

<p class=MsoListParagraphCxSpMiddle align=center style='margin-left:0in;
text-align:center'><img border=0 width=624 height=381 id="Picture 1"
src="Debugging_image001.jpg"></p>

<p class=MsoListParagraphCxSpMiddle align=center style='margin-left:0in;
text-align:center'>Example Snap TraceAnalyzer</p>

<p class=MsoListParagraphCxSpMiddle align=center style='margin-left:0in;
text-align:center'>&nbsp;</p>

<p class=MsoListParagraphCxSpLast align=center style='margin-left:0in;
text-align:center'>&nbsp;</p>

<h1 style='margin-left:0in'>Using USB audio device</h1>

<p class=MsoNormal style='margin-left:0in'>STVS4A has a mode able to monitor
Audio input and output. This tool is implemented in <b>service_audio_feed_usb.c.
</b>There are two way to use the module. If you doesn’t need this feature, you
can simply exclude this module from the project and the USB won’t be
initialized. Notice that this feature is deceived in DELIVERY Configurations.</p>

<p class=MsoNormal style='margin-left:0in'>&nbsp;</p>

<p class=MsoNormal style='margin-left:0in'>Otherwise you can connect the USB HS
socket to your PC and you will see a new Recording device        called “<b>STM32
Audio STVS4A in FS Mode</b>”. The Recording device supports 2 frequencies you
can change those frequencies using the property button and advanced Tab. The
Two frequencies are 16K (microphone frequency) and 48K (speaker frequency).</p>

<p class=MsoNormal style='margin-left:0in'>&nbsp;</p>

<p class=MsoListParagraphCxSpFirst style='text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Inject sample manually </p>

<p class=MsoListParagraphCxSpLast style='text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Inject Samples Automatically </p>

<p class=MsoNormal><b>&nbsp;</b></p>

<h2 style='margin-left:0in'>Inject sample manually </h2>

<p class=MsoNormal style='margin-left:0in'>&nbsp;</p>

<p class=MsoNormal style='margin-left:0in'>It is the default mode, this mode
supposes that you call the function <b>USER_USB_CopyBuffer </b>with the rights
parameters and you push stereo samples block manually. This mode is used to
debug audio streams and capture the audio wave from a buffer.</p>

<p class=MsoNormal style='margin-left:0in'>&nbsp;</p>

<h2 style='margin-left:0in'>Inject sample automatically</h2>

<p class=MsoNormal style='margin-left:0in'>&nbsp;</p>

<p class=MsoNormal style='margin-left:0in'>In this mode, the USB will be feed
by a callback directly from the audio porting layer. In this mode you have just
to define USB_CAPTURE_HOOK with an AVS_FEED_XXXX.  And the audio driver will
feed the USB driver directly. There are 3 callbacks registered in the porting
layer.</p>

<h2 style='margin-left:0in'>&nbsp;</h2>

<div align=center>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='border-collapse:collapse;border:none'>
 <tr>
  <td width=312 style='width:233.75pt;border:solid windowtext 1.0pt;padding:
  0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-left:0in'><span lang=FR>AVS_FEED_INPUT_CALLBACK           
  </span></p>
  </td>
  <td width=312 style='width:233.75pt;border:solid windowtext 1.0pt;border-left:
  none;padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-left:0in;text-align:justify'>The USB will be
  connected to the microphone , only the 1 first microphone will be used, the
  current implementation copy the Left sample in the right channel  </p>
  </td>
 </tr>
 <tr>
  <td width=312 style='width:233.75pt;border:solid windowtext 1.0pt;border-top:
  none;padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-left:0in'><span lang=FR>AVS_FEED_OUTPUT_CALLBACK</span></p>
  </td>
  <td width=312 style='width:233.75pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-left:0in;text-align:justify'>The USB will be
  connected to the speaker at 48K stereo. </p>
  </td>
 </tr>
 <tr>
  <td width=312 style='width:233.75pt;border:solid windowtext 1.0pt;border-top:
  none;padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-left:0in'><span lang=FR>AVS_FEED_AEC_CALLBACK</span></p>
  </td>
  <td width=312 style='width:233.75pt;border-top:none;border-left:none;
  border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-left:0in;text-align:justify'>If the porting
  layer has an echo cancellation, The USB will be connected to:  Channel Left
  audio coming from the microphone. Channel right, the microphone processed
  with the echo cancelation.</p>
  </td>
 </tr>
</table>

</div>

<p class=MsoNormal style='text-align:justify'>&nbsp;</p>

<p class=MsoNormal style='text-align:justify'>&nbsp;</p>

<h2 style='margin-left:0in'>How to use this tool</h2>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal style='margin-left:0in'>The first thing to do this to select
the right frequency in the “<b>STM32 Audio STVS4A in FS Mode</b>” device
property. If you capture the microhone or AEC, you have to select 16K otherwise
48K</p>

<p class=MsoNormal style='margin-left:0in'>Then, you can use a tool such as
Audacity (https://sourceforge.net/projects/audacity/) . Select the same
sampling rate and the “<b>STM32 Audio STVS4A in FS Mode</b>” device.</p>

<p class=MsoNormal style='margin-left:0in'>STVS4A will acts such as a
microphone that you can record</p>

<p class=MsoNormal style='margin-left:0in'>&nbsp;</p>

<p class=MsoNormal style='margin-left:0in'>&nbsp;</p>

<p class=MsoNormal style='margin-left:0in'>&nbsp;</p>

<p class=MsoListParagraphCxSpFirst align=center style='margin-left:0in;
text-align:center'>&nbsp;</p>

<p class=MsoListParagraphCxSpMiddle align=center style='margin-left:0in;
text-align:center'>&nbsp;</p>

<p class=MsoListParagraphCxSpLast align=center style='margin-left:0in;
text-align:center'>&nbsp;</p>

</div>

</body>

</html>
 </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.4 </li>
  </ul>
</div>
</body>
</html>
