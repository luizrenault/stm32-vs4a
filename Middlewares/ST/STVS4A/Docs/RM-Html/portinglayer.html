<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.4"/>
<title>STVS4A: Porting Layer</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="ST_logo-small.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">STVS4A
   &#160;<span id="projectnumber">v1.1.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.4 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('portinglayer.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Porting Layer </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><html>

<head>
<meta http-equiv=Content-Type content="text/html; charset=utf-8">
<meta name=Generator content="Microsoft Word 15 (filtered)">
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:Wingdings;
	panose-1:5 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:"Calibri Light";
	panose-1:2 15 3 2 2 2 4 3 2 4;}
@font-face
	{font-family:Calibri;
	panose-1:2 15 5 2 2 2 4 3 2 4;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:8.0pt;
	margin-left:0in;
	line-height:107%;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
h1
	{mso-style-link:"Heading 1 Char";
	margin-top:12.0pt;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:0in;
	margin-bottom:.0001pt;
	line-height:107%;
	page-break-after:avoid;
	font-size:16.0pt;
	font-family:"Calibri Light",sans-serif;
	color:#2E74B5;
	font-weight:normal;}
h2
	{mso-style-link:"Heading 2 Char";
	margin-top:2.0pt;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:0in;
	margin-bottom:.0001pt;
	line-height:107%;
	page-break-after:avoid;
	font-size:13.0pt;
	font-family:"Calibri Light",sans-serif;
	color:#2E74B5;
	font-weight:normal;}
h3
	{mso-style-link:"Heading 3 Char";
	margin-top:2.0pt;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:0in;
	margin-bottom:.0001pt;
	line-height:107%;
	page-break-after:avoid;
	font-size:12.0pt;
	font-family:"Calibri Light",sans-serif;
	color:#1F4D78;
	font-weight:normal;}
p
	{margin-right:0in;
	margin-left:0in;
	font-size:12.0pt;
	font-family:"Times New Roman",serif;}
p.MsoListParagraph, li.MsoListParagraph, div.MsoListParagraph
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:8.0pt;
	margin-left:.5in;
	line-height:107%;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
p.MsoListParagraphCxSpFirst, li.MsoListParagraphCxSpFirst, div.MsoListParagraphCxSpFirst
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.5in;
	margin-bottom:.0001pt;
	line-height:107%;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
p.MsoListParagraphCxSpMiddle, li.MsoListParagraphCxSpMiddle, div.MsoListParagraphCxSpMiddle
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.5in;
	margin-bottom:.0001pt;
	line-height:107%;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
p.MsoListParagraphCxSpLast, li.MsoListParagraphCxSpLast, div.MsoListParagraphCxSpLast
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:8.0pt;
	margin-left:.5in;
	line-height:107%;
	font-size:11.0pt;
	font-family:"Calibri",sans-serif;}
span.Heading1Char
	{mso-style-name:"Heading 1 Char";
	mso-style-link:"Heading 1";
	font-family:"Calibri Light",sans-serif;
	color:#2E74B5;}
span.Heading2Char
	{mso-style-name:"Heading 2 Char";
	mso-style-link:"Heading 2";
	font-family:"Calibri Light",sans-serif;
	color:#2E74B5;}
span.Heading3Char
	{mso-style-name:"Heading 3 Char";
	mso-style-link:"Heading 3";
	font-family:"Calibri Light",sans-serif;
	color:#1F4D78;}
.MsoChpDefault
	{font-family:"Calibri",sans-serif;}
.MsoPapDefault
	{margin-bottom:8.0pt;
	line-height:107%;}
@page WordSection1
	{size:8.5in 11.0in;
	margin:1.0in 1.0in 1.0in 1.0in;}
div.WordSection1
	{page:WordSection1;}
 /* List Definitions */
 ol
	{margin-bottom:0in;}
ul
	{margin-bottom:0in;}
-->
</style>

</head>

<body lang=EN-US>

<div class=WordSection1>

<p class=MsoNormal>&nbsp;</p>

<h1>Introduction</h1>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal style='text-align:justify'>The porting layer is not part of
the STVS4A exposition, this section describes roughly the porting layer
architecture and won’t go in the detail because this module could change in the
future.</p>

<p class=MsoNormal style='text-align:justify'> STVS4A has been designed to
support various board and hardware configuration. When STVS4A core need a low-level
service, it uses a driver and IOCTL and some abstraction functions. Drivers and
abstraction functions are implemented in the Porting Layer module.  For
example, using the porting layer, it easy to add a word spotting recognition,
or add a deported microphone connected by Bluetooth such as Blue coin or an
audio front end hardware processing bean forming or echo cancellation. The code
that support those new HW configuration will takes place in the porting layer
and STVS4A core won’t be changed.  Its location is <b>src/porting</b> and is
organized as follow.</p>

<p class=MsoNormal style='text-align:justify'>&nbsp;</p>

<div align=center>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='border-collapse:collapse;border:none'>
 <tr>
  <td width=312 valign=top style='width:233.75pt;border:solid windowtext 1.0pt;
  background:#D9D9D9;padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'><b>Folder name</b></p>
  </td>
  <td width=312 valign=top style='width:233.75pt;border:solid windowtext 1.0pt;
  border-left:none;background:#D9D9D9;padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'><b>Comments</b></p>
  </td>
 </tr>
 <tr>
  <td width=312 style='width:233.75pt;border:solid windowtext 1.0pt;border-top:
  none;background:#D9D9D9;padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'>Common</p>
  </td>
  <td width=312 valign=top style='width:233.75pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'>This folder includes some functions completion
  supporting extra services such as compiler support, MP3 player, sys timer,
  etc.</p>
  </td>
 </tr>
 <tr>
  <td width=312 style='width:233.75pt;border:solid windowtext 1.0pt;border-top:
  none;background:#D9D9D9;padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'>Network</p>
  </td>
  <td width=312 valign=top style='width:233.75pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'>The folder exposes some GLUE for network low-level
  abstraction.</p>
  </td>
 </tr>
 <tr>
  <td width=312 style='width:233.75pt;border:solid windowtext 1.0pt;border-top:
  none;background:#D9D9D9;padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'>stm32F7xx/XXX</p>
  </td>
  <td width=312 valign=top style='width:233.75pt;border-top:none;border-left:
  none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;
  padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;text-align:
  justify;line-height:normal'>This folder exposes some GLUE for the board
  support. Each entry in the folder represent an HW configuration variance.  </p>
  </td>
 </tr>
</table>

</div>

<p class=MsoNormal>&nbsp;</p>

<h1>Porting Drivers </h1>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal style='text-align:justify'>Internally, STVS4A exposes 3
drivers as global variables. STVS4A core uses only those drivers to communicate
and initialize the HW. </p>

<p class=MsoNormal>&nbsp;</p>

<div align=center>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='background:#D9D9D9;border-collapse:collapse;border:none'>
 <tr>
  <td width=623 valign=top style='width:467.5pt;border:solid windowtext 1.0pt;
  padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'>&nbsp;</p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'>extern          AVS_porting_audio      drv_audio;</p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'>extern          AVS_porting_instance drv_instance;</p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'>extern          AVS_porting_sys           drv_sys;</p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'>&nbsp;</p>
  </td>
 </tr>
</table>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>During the init/term, the STVS4A core will call those drivers
and will assume that the Init is done. Each failure during this phase will
cause a fatal assertion. Drivers have the following specific meaning. </p>

<p class=MsoListParagraphCxSpFirst style='text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>AVS_porting_audio                        Supports all audio
aspects </p>

<p class=MsoListParagraphCxSpMiddle style='margin-bottom:0in;margin-bottom:
.0001pt;text-indent:-.25in'><span style='font-family:Symbol'>·<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>AVS_porting_sys                             Supports variance or
specific board features </p>

<p class=MsoListParagraphCxSpLast style='margin-bottom:0in;margin-bottom:.0001pt;
text-indent:-.25in'><span style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>AVS_porting_instance                   Supports the default
configuration and specific features</p>

<p class=MsoNormal style='margin-top:0in;margin-right:0in;margin-bottom:0in;
margin-left:.25in;margin-bottom:.0001pt'>&nbsp;</p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt'>STVS4A uses
also abstraction functions to inter-connect external API to STVS4A modules.
This mainly the case for TLS/Network and common services</p>

<h1>STVS4A Initialization Sequence </h1>

<p class=MsoNormal style='text-align:justify'>&nbsp;</p>

<p class=MsoNormal style='text-align:justify'>When the application initializes STVS4A,
the core will first call all drivers default functions in order to visit the
factory and replace the zero values by a real default value compatible with the
configuration. Then, the STVS4A core will initialize the audio pipelines and
will call <b>platform_Audio_init</b>. After this step, STVS4A will call
platform_MP3_decoder_init and will start audio voice and speaker threads. At
this point the audio is fully initialized and functional.  Then, STVS4A will
continue the initialization by calling <b>avs_network_config, </b>this function
is an abstraction function and is implemented in the porting layer. <b>avs_network_config
</b>is in charge to create an IP stack and update the factory with correct IP
Gateway DNS. More generally, <b>avs_network_config </b>initialize all
dependencies mandatory for the HTTP/2 modules. Next steps are purely software
and initialize the state module and finally the token module.</p>

<h1>Create a new HW configuration </h1>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal style='text-align:justify'>Supporting a new configuration
supposes to implement the function <b>drv_platform_Init</b>, STVS4A will call
this function at the very beginning of its initialization.  This call must fill
<b>drv_audio</b>, <b>drv_instance</b>, <b>drv_sys</b> with appropriate
callbacks.  Some callbacks are mandatory such as init() and term(), some others
are  not. During in the initialization process, STVS4A will fill all callbacks
by a dummy callback returning always AVS_NOT_IMP. Some callbacks are present
only for future extensions or specific configuration and are not implemented
yet. The following code shows how to initialize a basic configuration.</p>

<p class=MsoNormal>&nbsp;</p>

<div align=center>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='background:#D9D9D9;border-collapse:collapse;border:none'>
 <tr>
  <td width=623 valign=top style='width:467.5pt;border:solid windowtext 1.0pt;
  border-bottom:none;padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'><span style='font-size:9.0pt'>AVS_Result drv_platform_Init(void)</span></p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'><span style='font-size:9.0pt'>{</span></p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'><span style='font-size:9.0pt'>  drv_sys.platform_Sys_init =    
  platform_Sys_init;</span></p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'><span style='font-size:9.0pt'>  drv_sys.platform_Sys_rnd  =    
  platform_Sys_rnd;</span></p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'><span style='font-size:9.0pt'>  drv_sys.platform_Sys_ioctl =    
  platform_Sys_ioctl;</span></p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'><span style='font-size:9.0pt'>  drv_instance.platform_init =    
  platform_init;</span></p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'><span style='font-size:9.0pt'>  drv_audio.platform_Audio_init  =
  platform_Audio_init;</span></p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'><span style='font-size:9.0pt'>  drv_audio.platform_Audio_term  =
  platform_Audio_term;</span></p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'><span style='font-size:9.0pt'>  drv_audio.platform_Audio_ioctl =
  platform_Audio_ioctl;</span></p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'><span style='font-size:9.0pt'>  drv_audio.platform_Audio_default =
  platform_Audio_default;</span></p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'><span style='font-size:9.0pt'>  /* Init the audio mp3 SW decoder */</span></p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'><span style='font-size:9.0pt'>  drv_audio.platform_MP3_decoder_init =
  platform_MP3_decoder_init;</span></p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'><span style='font-size:9.0pt'>  drv_audio.platform_MP3_decoder_term =
  platform_MP3_decoder_term ;</span></p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'><span style='font-size:9.0pt'>  drv_audio.platform_MP3_decoder_ioctl
  = platform_MP3_decoder_ioctl;</span></p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'><span style='font-size:9.0pt'>  drv_audio.platform_MP3_decoder_inject
  = platform_MP3_decoder_inject;</span></p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'><span style='font-size:9.0pt'>  /* Init the network support phy */</span></p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'><span style='font-size:9.0pt'>  drv_sys.platform_Network_init =
  platform_Network_init;</span></p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'><span style='font-size:9.0pt'>  drv_sys.platform_Network_term =
  platform_Network_term;</span></p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'><span style='font-size:9.0pt'>  drv_sys.platform_Network_ioctl =
  platform_Network_ioctl;</span></p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'><span style='font-size:9.0pt'>  drv_sys.platform_Network_Solve_macAddr
  = platform_Network_Solve_macAddr;</span></p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'><span style='font-size:9.0pt'>  return AVS_OK;</span></p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'><span style='font-size:9.0pt'>}</span></p>
  </td>
 </tr>
</table>

</div>

<p class=MsoNormal align=center style='text-align:center'><span
style='font-size:9.0pt;line-height:107%'>Driver initialization example</span></p>

<p class=MsoNormal> </p>

<h1>HW Configurations template </h1>

<h2>&nbsp;</h2>

<h2>avs_porting.h</h2>

<p class=MsoNormal style='text-align:justify;text-indent:.5in'>This file is
included by<b> avs.h</b> and exposes variances or update concerning the HW
configuration. </p>

<h2>avs_porting_bsp_xx.h</h2>

<p class=MsoNormal style='margin-left:.5in'>This file is included by all
configuration source code and declares all common prototypes and types.</p>

<h2>avs_porting_bsp_xx.c</h2>

<p class=MsoNormal style='margin-left:.5in'>This file implement drv_platform_Init
and overload some factory parameters such as CPU info, Configuration name, STVS4A
HW profile, etc. </p>

<h2>avs_porting_bsp_xx_sys.c</h2>

<p class=MsoNormal style='margin-left:.5in'>This file Implements Implement <b>platform_Sys_init/platform_Sys_term</b>
and all optional functions according to the board configuration. </p>

<h2> avs_porting_bsp_F7_audio.c</h2>

<p class=MsoNormal style='margin-left:.5in'>This file Implements drv_platform_Init,
platform_Audio_default, platform_Audio_term. <b>drv_platform_Init</b> is in
charge to analyze the factory and configure the audio HW according to the Board
features.  <b>platform_Audio_default</b> initialize default value for this
configuration. <b>platform_Audio_term</b> Terminate the audio driver.</p>

<h2>avs_porting_bsp_F7_audio_imp.c</h2>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal style='margin-left:.5in;text-align:justify'>This file
implements most of the active configuration code.  For Audio init/term/ioctl.
During the audio initialization, STVS4A will create 3 audio pipelines. The
recognizerPipe, synthesizerPipe, auxAudioPipe. An audio pipeline is composed of
2 ring buffers, in the inBuffer and the outBuffer.  STVS4A core expects that
the porting layer initialize the first part of the pipeline (bufferIn or
bufferOut according to the pipe type). Then, STVS4A core will compute the
second part of the pipeline using parameters comming from the first part of the
pipeline.</p>

<h1>Initialization steps </h1>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal style='text-align:justify'>The poring layer Initialize first
pipelines according to their features and factory parameters.  Basically, the
initialization is done in 3 steps.</p>

<p class=MsoListParagraphCxSpFirst style='text-align:justify;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Audio Board HW initialization</p>

<p class=MsoListParagraphCxSpMiddle style='margin-left:1.0in;text-align:justify;
text-indent:-.25in'><span style='font-family:"Courier New"'>o<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span>Audio
initialization could be done using the ST BSP, Bluetooth, specific code. The HW
will need to feed ring buffers.</p>

<p class=MsoListParagraphCxSpMiddle style='text-align:justify;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Finalize the pipelines initialization</p>

<p class=MsoListParagraphCxSpMiddle style='margin-left:1.0in;text-align:justify;
text-indent:-.25in'><span style='font-family:"Courier New"'>o<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span>Use <b>avs_audio_buffer_create</b>
with the buffer placement and size for <b>synthesizerPipe</b> and <b>recognizerPipe</b>
ring buffers and optionally <b>auxAudioPipe.  synthesizerPipe</b> and <b>auxAudioPipe</b>
must have the buffer parameters.</p>

<p class=MsoListParagraphCxSpMiddle style='text-align:justify;text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Start the audio pumping</p>

<p class=MsoListParagraphCxSpMiddle style='margin-left:1.0in;text-align:justify;
text-indent:-.25in'><span style='font-family:"Courier New"'>o<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span>Feeds <b>recognizerPipe.</b>
<b>InBuffer </b>with sample coming from the microphone.</p>

<p class=MsoListParagraphCxSpMiddle style='margin-left:1.0in;text-align:justify;
text-indent:-.25in'><span style='font-family:"Courier New"'>o<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span>Fill the HW
with samples coming from <b>synthesizerPipe.</b> <b>outBuffer.</b></p>

<p class=MsoListParagraphCxSpLast style='margin-left:1.0in;text-align:justify;
text-indent:-.25in'><span style='font-family:"Courier New";color:black'>o<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp; </span></span><span
style='color:black'>Do nothing with the pipe <b>auxAudioPipe</b>, the pipe will
be mixed with <b>synthesizerPipe</b> by the STVS4A core.</span></p>

<p class=MsoNormal style='text-align:justify'>&nbsp;</p>

<h1>Pumping audio samples architecture</h1>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt'>The audio
sample pumping model used by STVS4A core is the “half size buffer”. This means
that we feed or consume buffer half size by half size and during time where the
second part of the buffer is locked by the HW, we can process the first part. This
model is commonly used by the HW. STVS4A core expect to be signaled when a half
buffer is produced or consumed.  When the ring buffer has received or consumed
an half buffer, the driver set the flag   <b>pipe.pipeFlags</b> with
AVS_PIPE_EVT_HALF and signal an event to the audio thread. The following code
shows how to signals an audio buffer change state to the STVS4A audio core.  </p>

<p class=MsoNormal>&nbsp;</p>

<div align=center>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='background:#D9D9D9;border-collapse:collapse;border:none'>
 <tr>
  <td width=623 valign=top style='width:467.5pt;border:solid windowtext 1.0pt;
  padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'>&nbsp;</p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'>gHandle-&gt;synthesizerPipe.pipeFlags |= AVS_PIPE_EVT_HALF;</p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'> avs_core_terminat_isr(avs_core_event_set_isr(&amp;gHandle-&gt;synthesizerPipe.outEvent));</p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'>&nbsp;</p>
  </td>
 </tr>
</table>

</div>

<p class=MsoNormal align=center style='text-align:center'>Type code signaling a
synthesizer half buffer consumed</p>

<p class=MsoNormal>&nbsp;</p>

<div align=center>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='background:#D9D9D9;border-collapse:collapse;border:none'>
 <tr>
  <td width=623 valign=top style='width:467.5pt;border:solid windowtext 1.0pt;
  padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'>&nbsp;</p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'>  gHandle-&gt;synthesizerPipe.pipeFlags &amp;=
  (~(uint32_t)AVS_PIPE_EVT_HALF);</p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'> 
  avs_core_terminat_isr(avs_core_event_set_isr(&amp;gHandle-&gt;synthesizerPipe.outEvent));</p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'>&nbsp;</p>
  </td>
 </tr>
</table>

</div>

<p class=MsoNormal align=center style='text-align:center'>Typical code to
signaling a synthesizer buffer fully consumed</p>

<h2>Pumping model </h2>

<p class=MsoNormal style='text-align:justify'>&nbsp;</p>

<p class=MsoNormal style='text-align:justify'>For the best performance, the HW
buffer must be share with the STVS4A ring buffer. In this case the when the HW
raise interruption, the driver signals a half buffer processed and the STVS4A
audio thread will process it.</p>

<p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt'>&nbsp;</p>

<div align=center>

<table class=MsoTableGrid border=0 cellspacing=0 cellpadding=0
 style='border-collapse:collapse;border:none'>
 <tr>
  <td width=623 valign=top style='width:467.5pt;padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal align=center style='margin-bottom:0in;margin-bottom:.0001pt;
  text-align:center;line-height:normal'><img width=438 height=255 id="Picture 3"
  src="PortingLayer_image001.jpg"></p>
  </td>
 </tr>
</table>

</div>

<p class=MsoNormal style='text-align:justify'>In some case, the interruption
rate is too high to leave enough processing time to the STVS4A audio thread
(example if the interruption rate is 1 millisecond). In this case, the driver
must disconnect the HW buffer from the ring buffer and use a bigger ring buffer
than the HW and copy blocks by blocks samples in the ring buffer.</p>

<p class=MsoNormal style='text-align:justify'>&nbsp;</p>

<div align=center>

<table class=MsoTableGrid border=0 cellspacing=0 cellpadding=0
 style='border-collapse:collapse;border:none'>
 <tr>
  <td width=623 valign=top style='width:467.5pt;padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'><img width=580 height=420 id="Picture 1"
  src="PortingLayer_image002.jpg"></p>
  </td>
 </tr>
</table>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoListParagraph style='margin-left:0in'>&nbsp;</p>

<h1>Working with IOCTL</h1>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal style='text-align:justify'>A driver exposes a function
callback IOCTL. It is natural way for an application to work directly with the
driver. There to kind of IOCTL, IOCTL standard defined in <b>avs.h</b> and
IOCTL specific to a configuration defined in <b>avs_porting.h</b>. And IOCTL is
not supposed mandatory, by default, not handled IOCTL returns _NOT_IMP.</p>

<p class=MsoNormal>&nbsp;</p>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0 align=left
 style='background:#D9D9D9;border-collapse:collapse;border:none;margin-left:
 6.75pt;margin-right:6.75pt'>
 <tr>
  <td width=707 valign=top style='width:607.1pt;border:solid windowtext 1.0pt;
  padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'>  <span lang=FR>uint32_t  (*platform_XXX_ioctl)(AVS_instance_handle
  *pHandle, uint32_t code, uint32_t wparam, uint32_t lparam);</span></p>
  <p class=MsoNormal align=center style='margin-bottom:0in;margin-bottom:.0001pt;
  text-align:center;line-height:normal'><span lang=FR>&nbsp;</span></p>
  </td>
 </tr>
</table>

<p class=MsoNormal><span lang=FR>&nbsp;</span></p>

<p class=MsoNormal align=center style='text-align:center'><span lang=FR>IOCTL prototype</span></p>

<p class=MsoNormal><b>wparam</b>, and <b>wparam</b>  are not typed,  It is up
the driver to interpret parameters properly and cast those values according to
the parameters meaning.</p>

<p class=MsoNormal>&nbsp;</p>

<h1>Working with Events</h1>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal style='text-align:justify'>There to kind of events, Events
standard defined in <b>avs.h</b> and specifics to the configuration defined in <b>avs_porting.h</b>.
When a driver wants to communicate with the application, it can send a standard
or nonstandard event. For example, if the driver supports a word spotting
recognizer. When the Keyword is detected, the driver sends the event EVT_WAKEUP.</p>

<p class=MsoNormal>&nbsp;</p>

<div align=center>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='background:#D9D9D9;border-collapse:collapse;border:none'>
 <tr>
  <td width=623 valign=top style='width:467.5pt;border:solid windowtext 1.0pt;
  padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'>static int32_t afe_voice_trigger_found(uint32_t instance, uint32_t
  commandIndex)</p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'>{</p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'>  AVS_instance_handle *pInstance = avs_core_get_instance();</p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'>  avs_core_message_send(pInstance, EVT_WAKEUP, commandIndex);</p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'>  return AVS_OK;</p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'>}</p>
  </td>
 </tr>
</table>

</div>

<p class=MsoNormal>&nbsp;</p>

<h1>Working with Word spotting </h1>

<p class=MsoNormal style='text-align:justify'>&nbsp;</p>

<p class=MsoNormal style='text-align:justify'>The default STVS4A configuration (BSP)
doesn’t provide Word Spotting support. But it is easy to add this feature if
you have an API able to recognize an audio word. If you have a word spotting
support, you have to manage the audio microphone feed. Samples coming from the
microphone must be routed to AVS when a ALEXA dialogue starts and routed to the
word spotting when STVS4A is Idle.  When STVS4A has no longer need the
microphone, it signals this state by the IOCTL AVS_IOCTL_CAPTURE_FEED to the
audio driver.  Using this IOCTL, it is easy to route properly the audio
microphone samples.</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>&nbsp;</p>

<div align=center>

<table class=MsoTableGrid border=0 cellspacing=0 cellpadding=0
 style='border-collapse:collapse;border:none'>
 <tr>
  <td width=1149 valign=top style='width:556.3pt;padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'><img width=1135 height=563 id="Picture 5"
  src="PortingLayer_image003.jpg"></p>
  </td>
 </tr>
</table>

</div>

<p class=MsoNormal align=center style='text-align:center'>Audio samples routing</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal style='text-align:justify'>As soon as this architecture is
in place, you need to signal to STVS4A to transit from the IDLE state to the
StartCapture state. This could be done using <b>AVS_Set_State() </b>or in the
demo provided with  the package simply Send the Event EVT_WAKEUP using the 
function <b>AVS_Send_Evt</b>(). There is a last thing to do to complete the
support of the word spotting. You need to change the AVS device profile to
“Voice Initiated). This could be done in the factory by setting the field
initiator to AVS_INITIATOR_VOICE_INITIATED.</p>

<p class=MsoNormal>&nbsp;</p>

<div align=center>

<table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0
 style='background:#D9D9D9;border-collapse:collapse;border:none'>
 <tr>
  <td width=707 valign=top style='width:661.4pt;border:solid windowtext 1.0pt;
  padding:0in 5.4pt 0in 5.4pt'>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'>&nbsp;</p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'>  avs_init_default_interger(&amp;pHandle-&gt;pFactory-&gt;profile,
  AVS_PROFILE_NEAR_FIELD);</p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'>  avs_init_default_interger(&amp;pHandle-&gt;pFactory-&gt;initiator,
  AVS_INITIATOR_VOICE_INITIATED);</p>
  <p class=MsoNormal style='margin-bottom:0in;margin-bottom:.0001pt;line-height:
  normal'>&nbsp;</p>
  </td>
 </tr>
</table>

</div>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>&nbsp;</p>

</div>

</body>

</html>
 </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.4 </li>
  </ul>
</div>
</body>
</html>
